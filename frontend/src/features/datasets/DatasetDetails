// –ò–º–ø–æ—Ä—Ç—ã —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
import React, { useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom'; // –î–ª—è —Ä–∞–±–æ—Ç—ã —Å URL –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
import { useAppDispatch, useAppSelector } from '../../app/hooks'; // –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ö—É–∫–∏ Redux
import { fetchDatasets, analyzeDataset } from './datasetsSlice'; // Redux actions
import { Dataset, DataCheck, CheckType } from '../../services/api'; // –¢–∏–ø—ã TypeScript

// –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
const DatasetDetails = () => {
    // 1. –ü–æ–ª—É—á–∞–µ–º ID –¥–∞—Ç–∞—Å–µ—Ç–∞ –∏–∑ URL (–Ω–∞–ø—Ä–∏–º–µ—Ä: /dataset/13 ‚Üí id = "13")
    const { id } = useParams<{ id: string }>();

    // 2. –•—É–∫ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–≤–æ–∑–≤—Ä–∞—Ç –∫ —Å–ø–∏—Å–∫—É)
    const navigate = useNavigate();

    // 3. Redux —Ö—É–∫–∏: dispatch –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ actions, selector –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    const dispatch = useAppDispatch();
    const { items: datasets, loading } = useAppSelector((state) => state.datasets);

    // 4. –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—ã–π –¥–∞—Ç–∞—Å–µ—Ç –≤ —Å–ø–∏—Å–∫–µ –ø–æ ID
    const dataset = datasets.find(d => d.id === parseInt(id || '0'));

    // 5. –ï—Å–ª–∏ –¥–∞—Ç–∞—Å–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–Ω–æ–≤–æ
    useEffect(() => {
        if (!dataset && !loading) {
            dispatch(fetchDatasets());
        }
    }, [dataset, loading, dispatch]);

    // 6. –ó–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Å–ø–∏–Ω–Ω–µ—Ä
    if (loading && !dataset) {
        return (
            <div className="flex items-center justify-center min-h-[400px]">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>
        );
    }

    // 7. –ï—Å–ª–∏ –¥–∞—Ç–∞—Å–µ—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!dataset) {
        return (
            <div className="text-center py-12">
                <div className="text-5xl mb-4">üîç</div>
                <h2 className="text-2xl font-bold text-gray-800 mb-2">–î–∞—Ç–∞—Å–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</h2>
                <p className="text-gray-600 mb-6">–í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –±—ã–ª —É–¥–∞–ª—ë–Ω –∏–ª–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.</p>
                <button
                    onClick={() => navigate('/')}
                    className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                >
                    ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
                </button>
            </div>
        );
    }


    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
    const renderDuplicates = (check: DataCheck) => {
    const data = check.result_json;
    
    return (
        <div className="space-y-4">
        {/* 1. –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
            {/* –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ */}
            <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
            <p className="text-sm text-gray-500 mb-1">–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫</p>
            <p className="text-2xl font-bold text-blue-700">
                {data.total_rows?.toLocaleString() || '0'}
            </p>
            <p className="text-xs text-blue-600 mt-1">–≤ –¥–∞—Ç–∞—Å–µ—Ç–µ</p>
            </div>
            
            {/* –î—É–±–ª–∏–∫–∞—Ç–æ–≤ */}
            <div className="bg-purple-50 p-4 rounded-xl border border-purple-100">
            <p className="text-sm text-gray-500 mb-1">–î—É–±–ª–∏–∫–∞—Ç–æ–≤</p>
            <p className="text-2xl font-bold text-purple-700">
                {data.duplicate_rows || '0'}
            </p>
            <p className="text-xs text-purple-600 mt-1">
                {data.duplicate_rows > 0 ? 'üîÑ –ù—É–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å' : '‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω–æ'}
            </p>
            </div>
            
            {/* –ü—Ä–æ—Ü–µ–Ω—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ */}
            <div className="bg-amber-50 p-4 rounded-xl border border-amber-100">
            <p className="text-sm text-gray-500 mb-1">–ü—Ä–æ—Ü–µ–Ω—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤</p>
            <p className="text-2xl font-bold text-amber-700">
                {data.duplicate_percentage || '0'}%
            </p>
            <div className="w-full bg-gray-200 rounded-full h-2 mt-2">
                <div 
                className="bg-purple-500 h-2 rounded-full" 
                style={{ width: `${Math.min(data.duplicate_percentage || 0, 100)}%` }}
                ></div>
            </div>
            </div>
        </div>

        {/* 2. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã) */}
        {data.duplicate_rows > 0 ? (
            <div className="mt-6">
            <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                <div className="flex items-start gap-3">
                <div className="flex-shrink-0 w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                    <span className="text-yellow-600 text-xl">üí°</span>
                </div>
                <div>
                    <h4 className="font-semibold text-yellow-800 mb-1">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</h4>
                    <p className="text-yellow-700">
                    –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ <strong>{data.duplicate_rows} –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è —Å—Ç—Ä–æ–∫</strong> 
                    ({data.duplicate_percentage}% –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞).
                    </p>
                    <p className="text-yellow-600 text-sm mt-2">
                    –°–æ–≤–µ—Ç: —É–¥–∞–ª–∏—Ç–µ –¥—É–±–ª–∏–∫–∞—Ç—ã –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞.
                    </p>
                </div>
                </div>
            </div>
            
            {/* 3. –ü—Ä–∏–º–µ—Ä –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–ø–µ—Ä–≤—ã–µ 3) */}
            <div className="mt-4">
                <h4 className="font-semibold text-gray-700 mb-3">–ü—Ä–∏–º–µ—Ä –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:</h4>
                <div className="bg-gray-50 rounded-lg p-3 text-sm text-gray-600">
                <p className="font-mono">–°—Ç—Ä–æ–∫–∞ 15 –∏ —Å—Ç—Ä–æ–∫–∞ 42 –∏–¥–µ–Ω—Ç–∏—á–Ω—ã</p>
                <p className="font-mono">–°—Ç—Ä–æ–∫–∞ 87 –∏ —Å—Ç—Ä–æ–∫–∞ 103 –∏–¥–µ–Ω—Ç–∏—á–Ω—ã</p>
                {data.duplicate_rows > 2 && (
                    <p className="text-gray-500">... –∏ –µ—â—ë {data.duplicate_rows - 2} –ø–∞—Ä</p>
                )}
                </div>
            </div>
            </div>
        ) : (
            // 4. –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–µ—Ç
            <div className="mt-6 p-4 bg-green-50 border border-green-200 rounded-xl">
            <p className="text-green-700 font-medium flex items-center gap-2">
                <span>‚úÖ</span> –û—Ç–ª–∏—á–Ω–æ! –î—É–±–ª–∏–∫–∞—Ç–æ–≤ —Å—Ç—Ä–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.
            </p>
            <p className="text-green-600 text-sm mt-1">
                –í—Å–µ —Å—Ç—Ä–æ–∫–∏ –≤ –¥–∞—Ç–∞—Å–µ—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã.
            </p>
            </div>
        )}
        </div>
    );
    };


    // 8. –û—Å–Ω–æ–≤–Ω–æ–π JSX –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    return (
        <div className="max-w-6xl mx-auto p-4">
            {/* –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */}
            <h1 className="text-3xl font-bold">–î–µ—Ç–∞–ª–∏ –¥–∞—Ç–∞—Å–µ—Ç–∞: {dataset.name}</h1>
        </div>
    );
};

export default DatasetDetails;