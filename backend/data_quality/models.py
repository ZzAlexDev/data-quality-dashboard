# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –º–æ–¥—É–ª—å Django –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π
from django.db import models

# –ú–û–î–ï–õ–¨ 1: Dataset (–î–∞—Ç–∞—Å–µ—Ç - –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π CSV —Ñ–∞–π–ª)
class Dataset(models.Model):
    """
    –û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º CSV-—Ñ–∞–π–ª–µ.
    –ê–Ω–∞–ª–æ–≥ –ø–∞–ø–∫–∏ '–í—Ö–æ–¥—è—â–∏–µ' –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.
    """
    
    # –°–ü–†–ê–í–û–ß–ù–ò–ö –°–¢–ê–¢–£–°–û–í: –∑–∞–¥–∞—ë–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–±–æ—Ä–∞ –¥–ª—è –ø–æ–ª—è status
    # –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å—Ç–∞—Ç—É—Å –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∏–º –∏–∑ –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
    STATUS_CHOICES = [
        ('uploaded', 'üì• –ó–∞–≥—Ä—É–∂–µ–Ω'),      # –§–∞–π–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω
        ('processing', '‚öôÔ∏è –í –æ–±—Ä–∞–±–æ—Ç–∫–µ'), # –ò–¥—ë—Ç –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö
        ('completed', '‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω'),    # –ê–Ω–∞–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω
        ('failed', '‚ùå –û—à–∏–±–∫–∞'),          # –í –ø—Ä–æ—Ü–µ—Å—Å–µ –∞–Ω–∞–ª–∏–∑–∞ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞
    ]
    
    # –ü–û–õ–ï 1: –ù–∞–∑–≤–∞–Ω–∏–µ –¥–∞—Ç–∞—Å–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "sales_data_2024.csv")
    # CharField ‚Äî –¥–ª—è –∫–æ—Ä–æ—Ç–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. max_length=255 ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞.
    name = models.CharField('–ù–∞–∑–≤–∞–Ω–∏–µ', max_length=255)
    
    # –ü–û–õ–ï 2: –°—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    # FileField ‚Äî —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏.
    # upload_to='uploads/%Y/%m/%d/' ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø–æ –¥–∞—Ç–µ –≤ –ø–∞–ø–∫–µ media/uploads/2024/04/16/
    csv_file = models.FileField('CSV —Ñ–∞–π–ª', upload_to='uploads/%Y/%m/%d/')
    
    # –ü–û–õ–ï 3: –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏. auto_now_add=True ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏.
    uploaded_at = models.DateTimeField('–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏', auto_now_add=True)
    
    # –ü–û–õ–ï 4: –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏.
    # choices=STATUS_CHOICES ‚Äî –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –≤–≤–æ–¥ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –≤—ã—à–µ.
    # default='uploaded' ‚Äî –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–≤–∏—Ç—Å—è —Å—Ç–∞—Ç—É—Å 'uploaded'.
    status = models.CharField('–°—Ç–∞—Ç—É—Å', max_length=20, choices=STATUS_CHOICES, default='uploaded')
    
    # –°–¢–†–û–ö–û–í–û–ï –ü–†–ï–î–°–¢–ê–í–õ–ï–ù–ò–ï –æ–±—ä–µ–∫—Ç–∞. –ö–∞–∫ –º–æ–¥–µ–ª—å –±—É–¥–µ—Ç –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è –≤ –∞–¥–º–∏–Ω–∫–µ –∏ –∫–æ–Ω—Å–æ–ª–∏.
    def __str__(self):
        return f"{self.name} ({self.uploaded_at.date()})"
    
    # –ö–ª–∞—Å—Å Meta –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–æ–¥–µ–ª–∏
    class Meta:
        # –ó–∞–¥–∞—ë–º –ø–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: —Å–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é –¥–∞—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏).
        ordering = ['-uploaded_at']
        # –ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –∏–º—è –º–æ–¥–µ–ª–∏ –≤ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–º –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —á–∏—Å–ª–µ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏.
        verbose_name = '–î–∞—Ç–∞—Å–µ—Ç'
        verbose_name_plural = '–î–∞—Ç–∞—Å–µ—Ç—ã'


# –ú–û–î–ï–õ–¨ 2: DataCheck (–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö)
class DataCheck(models.Model):
    """
    –ú–æ–¥–µ–ª—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö.
    –û–¥–∏–Ω –¥–∞—Ç–∞—Å–µ—Ç (Dataset) –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ç–∞–∫–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫.
    """
    
    # –°–ü–†–ê–í–û–ß–ù–ò–ö –¢–ò–ü–û–í –ü–†–û–í–ï–†–û–ö
    CHECK_TYPES = [
        ('missing', 'üîç –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è'),
        ('duplicates', '‚ôªÔ∏è –î—É–±–ª–∏–∫–∞—Ç—ã —Å—Ç—Ä–æ–∫'),
        ('statistics', 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'),
    ]
    
    # –ü–û–õ–ï 1: –°–í–Ø–ó–¨ —Å –º–æ–¥–µ–ª—å—é Dataset. –≠—Ç–æ —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ –ø–æ–ª–µ.
    # ForeignKey ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–≤—è–∑—å "–º–Ω–æ–≥–∏–µ –∫ –æ–¥–Ω–æ–º—É". Many DataChecks ‚Üí One Dataset.
    # on_delete=models.CASCADE ‚Äî –∫–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ: –µ—Å–ª–∏ —É–¥–∞–ª–∏–º Dataset, –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ DataCheck —Ç–æ–∂–µ —É–¥–∞–ª—è—Ç—Å—è.
    # related_name='checks' ‚Äî –∫–∞–∫ –º—ã –±—É–¥–µ–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –ø—Ä–æ–≤–µ—Ä–∫–∞–º –∏–∑ –æ–±—ä–µ–∫—Ç–∞ Dataset: dataset.checks.all()
    dataset = models.ForeignKey(Dataset, on_delete=models.CASCADE, related_name='checks')
    
    # –ü–û–õ–ï 2: –¢–∏–ø –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ (–≤—ã–±–∏—Ä–∞–µ–º –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞).
    check_type = models.CharField('–¢–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏', max_length=20, choices=CHECK_TYPES)
    
    # –ü–û–õ–ï 3: –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON (–≥–∏–±–∫–æ, –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –ª—é–±—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö).
    # –ù–∞–ø—Ä–∏–º–µ—Ä: {"columns_with_missing": ["email"], "total_missing": 15, "percentage": 5.2}
    result_json = models.JSONField('–†–µ–∑—É–ª—å—Ç–∞—Ç (JSON)', default=dict, blank=True)
    
    # –ü–û–õ–ï 4: –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ –æ –ø—Ä–æ–≤–µ—Ä–∫–µ.
    created_at = models.DateTimeField('–°–æ–∑–¥–∞–Ω–æ', auto_now_add=True)
    
    def __str__(self):
        # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–∏–ø –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∏–º—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞
        return f"{self.get_check_type_display()} –¥–ª—è {self.dataset.name}"
    
    class Meta:
        ordering = ['-created_at']
        verbose_name = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö'
        verbose_name_plural = '–ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö'


# –ú–û–î–ï–õ–¨ 3: Report (–°–≤–æ–¥–Ω—ã–π –æ—Ç—á—ë—Ç)
class Report(models.Model):
    """
    –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç –ø–æ –≤—Å–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∞–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞.
    –°–≤—è–∑—å —Å Dataset: –æ–¥–∏–Ω –∫ –æ–¥–Ω–æ–º—É (One Dataset ‚Üí One Report).
    """
    
    # –ü–û–õ–ï 1: –°–í–Ø–ó–¨ "–æ–¥–∏–Ω –∫ –æ–¥–Ω–æ–º—É" —Å –º–æ–¥–µ–ª—å—é Dataset.
    # OneToOneField ‚Äî —É –∫–∞–∂–¥–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –æ—Ç—á—ë—Ç, –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç.
    # related_name='report' ‚Äî –æ–±—Ä–∞—â–µ–Ω–∏–µ: dataset.report
    dataset = models.OneToOneField(Dataset, on_delete=models.CASCADE, related_name='report')
    
    # –ü–û–õ–ï 2: –¢–µ–∫—Å—Ç–æ–≤–∞—è —Å–≤–æ–¥–∫–∞ (–≤—ã–≤–æ–¥—ã, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏).
    summary = models.TextField('–°–≤–æ–¥–∫–∞', blank=True)
    
    # –ü–û–õ–ï 3: –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º (–≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ DataCheck).
    issues_count = models.IntegerField('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–±–ª–µ–º', default=0)
    
    # –ü–û–õ–ï 4: –î–∞—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞.
    generated_at = models.DateTimeField('–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω', auto_now_add=True)
    
    def __str__(self):
        return f"–û—Ç—á—ë—Ç –¥–ª—è {self.dataset.name}"
    
    class Meta:
        verbose_name = '–û—Ç—á—ë—Ç'
        verbose_name_plural = '–û—Ç—á—ë—Ç—ã'